/*!
 * Objectmodel v3.0.0
 * http://objectmodel.js.org
 *
 * Copyright (c) 2017 Sylvain Pollet-Villard
 * Licensed under the MIT license
 */

!function(t,n){"object"==typeof exports&&"undefined"!=typeof module?n(exports):"function"==typeof define&&define.amd?define(["exports"],n):n(t.window=t.window||{})}(this,function(t){"use strict";function n(t,n){return n instanceof t}function e(t){return"string"==typeof t}function r(t){return"function"==typeof t}function i(t){return"object"==typeof t}function o(t){return t&&i(t)&&Object.getPrototypeOf(t)===Object.prototype}function c(t){return{}.toString.call(t).match(/\s([a-zA-Z]+)/)[1]}function s(t,n={},e,r){for(let i in n)if(r||n.hasOwnProperty(i))if(e&&o(n[i])){const r={};s(r,t[i],e),s(r,n[i],e),t[i]=r}else t[i]=n[i]}function u(t,n,e,r=!1){F(t,n,{value:e,enumerable:r,writable:!0,configurable:!0})}function f(t,n){Object.setPrototypeOf(t,n.prototype),u(t,"constructor",n)}function a(t,n,e){t.prototype=Object.assign(Object.create(n.prototype),{constructor:t},e)}function p(t,o=[]){if(o.length>15||o.includes(t))return"...";if(null===t||void 0===t)return String(t);if(e(t))return`"${t}"`;if(n(b,t))return t.toString(o);if(o=[t].concat(o),r(t))return t.name||t.toString(o);if(n(Array,t))return`[${t.map(t=>p(t,o)).join(", ")}]`;if(t.toString!==Object.prototype.toString)return t.toString();if(t&&i(t)){const n=Object.keys(t),e="\t".repeat(o.length);return`{${n.map(n=>`\n${e+n}: ${p(t[n],o)}`).join(",")} ${n.length?`\n${e.slice(1)}`:""}}`}return String(t)}function l(t){if(o(t))for(let n of Object.keys(t))t[n]=l(t[n]);else{if(!n(Array,t))return[t];if(1===t.length)return[...t,void 0,null]}return t}function h(t,e,r,i,c,s=!1){const u=c.indexOf(e);if(-1!==u&&-1!==c.indexOf(e,u+1))return t;if(s&&(t=g(t,e)),n(b,e))e._validate(t,r,i,c.concat(e));else if(o(e))Object.keys(e).forEach(n=>{const o=null!=t?t[n]:void 0;h(o,e[n],r?r+"."+n:n,i,c)});else{const n=l(e);if(n.some(n=>d(t,n,r,c)))return t;i.push({expected:e,received:t,path:r})}return t}function d(t,e,i,c){if(null==t)return t===e;if(o(e)||n(b,e)){const n=[];return h(t,e,i,n,c),!n.length}return n(RegExp,e)?e.test(t):e===Number||e===Date?t.constructor===e&&!isNaN(t):t===e||r(e)&&n(e,t)||t.constructor===e}function y(t,n,e,i=n.errors){for(let o of n.assertions){let c;try{c=o.call(n,t)}catch(t){c=t}if(!0!==c){const s=r(o.description)?o.description:(t,n)=>`assertion "${o.description}" returned ${p(t)} for value ${p(n)}`;i.push({message:s.call(n,c,t),expected:o,received:t,path:e})}}}function g(t,e=[]){if(!t||o(e)||n(b,t.constructor))return t;const r=l(e),i=[];for(let e of r)n(b,e)&&e.test(t)&&i.push(e);if(1===i.length){const e=i[0];return n(b,e)?e(t):new e(t)}return i.length>1&&console.warn(`Ambiguous model for value ${p(t)}, could be ${i.join(" or ")}`),t}function v(t){const n=function(t=n.default){return n.validate(t),t};return f(n,v),n._init(arguments),n}function O(t){const e=function(t=e.default){return n(e,this)?n(e,t)?t:(s(this,t,!0),e.hasOwnProperty("constructor")&&e.constructor.call(this,t),e.validate(this),w(e,this,e.definition)):new e(t)};return a(e,Object),f(e,O),e._init(arguments),e}function w(t,i,c,s){return o(c)?new Proxy(i||{},{getPrototypeOf(){return s?Object.prototype:t.prototype},get(i,u){if(!e(u))return Reflect.get(i,u);const f=s?s+"."+u:u,a=c[u];return u in c&&t.conventionForPrivate(u)?(t.errors.push({message:`cannot access to private property ${f}`}),void t.unstackErrors()):(i[u]&&i.hasOwnProperty(u)&&!o(a)&&!n(b,i[u].constructor)&&(i[u]=g(i[u],a)),r(i[u])&&i[u].bind?i[u].bind(i):w(t,i[u],a,f))},set(n,e,r){return m(t,c,s,n,e,i=>{Reflect.set(n,e,w(t,r,c[e],i))})},deleteProperty(n,e){return m(t,c,s,n,e,()=>Reflect.deleteProperty(n,e))},defineProperty(n,e,r){return m(t,c,s,n,e,()=>Reflect.defineProperty(n,e,r))},has(n,e){return Reflect.has(n,e)&&Reflect.has(c,e)&&!t.conventionForPrivate(e)},ownKeys(){return Reflect.ownKeys(c).filter(n=>!t.conventionForPrivate(n))},getOwnPropertyDescriptor(n,e){let r;return t.conventionForPrivate(e)||void 0!==(r=Object.getOwnPropertyDescriptor(c,e))&&(r.value=n[e]),r}}):g(i,c)}function m(t,n,e,r,i,o){const c=e?e+"."+i:i,s=t.conventionForPrivate(i),u=t.conventionForConstant(i),f=r.hasOwnProperty(i),a=f&&Object.getOwnPropertyDescriptor(r,i);return i in n&&(s||u&&void 0!==r[i])&&t.errors.push({message:`cannot modify ${s?"private":"constant"} ${i}`}),n.hasOwnProperty(i)?(o(c),h(r[i],n[i],c,t.errors,[]),y(r,t,c)):t.errors.push({message:`cannot find property ${c} in the model definition`}),!t.errors.length||(f?Object.defineProperty(r,i,a):delete r[i],t.unstackErrors(),!1)}function b(t){return o(t)?new O(t):new v(t)}function j(t){const e=function(t=e.default){return n(e,this)?(e.validate(t),new Proxy(t,{getPrototypeOf:()=>e.prototype,get(t,n){return A.includes(n)?P(t,n,e):t[n]},set(t,n,r){return x(t,n,r,e)},deleteProperty(t,n){return!(n in t)||x(t,n,void 0,e)}})):new e(t)};return a(e,Array),f(e,j),e._init(arguments),e}function P(t,n,e){return function(){const r=t.slice();[][n].apply(r,arguments),e.validate(r);const i=[][n].apply(t,arguments);return t.forEach((n,r)=>t[r]=g(n,e.definition)),i}}function x(t,n,e,r){let i=`Array[${n}]`;parseInt(n)===+n&&n>=0&&(e=h(e,r.definition,i,r.errors,[],!0));const o=t.slice();o[n]=e,y(o,r,i);const c=!r.unstackErrors();return c&&(t[n]=e),c}function M(){const t=function(n=t.default){return new Proxy(n,{getPrototypeOf:()=>t.prototype,apply(n,e,r){const i=t.definition;i.arguments.forEach((n,e)=>{r[e]=h(r[e],n,`arguments[${e}]`,t.errors,[],!0)}),y(r,t,"arguments");let o;return t.errors.length||(o=Reflect.apply(n,e,r),"return"in i&&(o=h(o,i.return,"return value",t.errors,[],!0))),t.unstackErrors(),o}})};return a(t,Function),f(t,M),t._init([{arguments:[...arguments]}]),t}function S(t){const n=function(t){const e=new Map(t);n.validate(e);for(let t of C)e[t]=function(){const r=new Map(e);return Map.prototype[t].apply(r,arguments),n.validate(r),Map.prototype[t].apply(e,arguments)};return f(e,n),e};return a(n,Map),f(n,S),n._init(arguments),n}function E(t){const n=function(t){const e=new Set(t);n.validate(e);for(let t of _)e[t]=function(){const r=new Set(e);return Set.prototype[t].apply(r,arguments),n.validate(r),Set.prototype[t].apply(e,arguments)};return f(e,n),e};return a(n,Set),f(n,E),n._init(arguments),n}const F=Object.defineProperty;a(v,b),a(O,b,{defaults(t){return Object.assign(this.prototype,t),this},toString(t){return p(this.definition,t)},extend(){const t={},e={},o=[...arguments];Object.assign(t,this.definition),s(e,this.prototype,!1,!0),o.forEach(o=>{n(b,o)&&s(t,o.definition,!0);r(o)&&s(e,o.prototype,!0,!0);i(o)&&s(t,o,!0,!0)}),delete e.constructor;let c=[...this.assertions];o.forEach(t=>{n(b,t)&&(c=c.concat(t.assertions))});const u=new this.constructor(t);return a(u,this,e),u.assertions=c,u.errorCollector=this.errorCollector,u},_validate(t,n,e,r){i(t)?h(t,this.definition,n,e,r):e.push({expected:this,received:t,path:n}),y(t,this,n,e)}}),Object.assign(b.prototype,{name:"Model",assertions:[],conventionForConstant:t=>t.toUpperCase()===t,conventionForPrivate:t=>"_"===t[0],toString(t){return l(this.definition).map(n=>p(n,t)).join(" or ")},as(t){return u(this,"name",t),this},defaultTo(t){return this.default=t,this},_init(t){if(0===t.length)throw new Error("Model definition is required");this.definition=t[0],this.assertions=this.assertions.slice(),u(this,"errors",[]),delete this.name},_validate(t,n,e,r){h(t,this.definition,n,e,r),y(t,this,n,e)},validate(t,n){this._validate(t,null,this.errors,[]),this.unstackErrors(n)},test(t){let n,e=this.errorCollector;return this.errorCollector=(()=>{n=!0}),new this(t),this.errorCollector=e,!n},unstackErrors(t){if(this.errors.length){t||(t=this.errorCollector);const e=this.errors.map(t=>{if(!t.message){const e=n(Array,t.expected)?t.expected:[t.expected];t.message="expecting "+(t.path?t.path+" to be ":"")+e.map(t=>p(t)).join(" or ")+", got "+(null!=t.received?c(t.received)+" ":"")+p(t.received)}return t});this.errors=[],t.call(this,e)}},errorCollector(t){let n=new TypeError(t.map(t=>t.message).join("\n"));throw n.stack=n.stack.replace(/\n.*object-model(.|\n)*object-model.*/,""),n},extend(...t){let e=this.definition;t.length>0&&(e=t.reduce((t,n)=>t.concat(n),Array.isArray(e)?e.slice():[e]).filter((t,n,e)=>e.indexOf(t)===n));let r=[...this.assertions];t.forEach(t=>{n(v,t)&&(r=r.concat(t.assertions))});const i=new this.constructor(e);return a(i,this),i.assertions=r,i.errorCollector=this.errorCollector,i},assert(t,n=p(t)){return u(t,"description",n),this.assertions=this.assertions.concat(t),this}});const A=["pop","push","reverse","shift","sort","splice","unshift"];a(j,b,{toString(t){return"Array of "+p(this.definition,t)},_validate(t,e,r,i){n(Array,t)?t.forEach((n,o)=>{t[o]=h(n,this.definition,`${e||"Array"}[${o}]`,r,i,!0)}):r.push({expected:this,received:t,path:e}),y(t,this,e,r)}}),a(M,b,{toString(t){let n="Function("+this.definition.arguments.map(n=>p(n,t)).join(",")+")";return"return"in this.definition&&(n+=" => "+p(this.definition.return)),n},return(t){return this.definition.return=t,this},_validate(t,n,e){r(t)||e.push({expected:"Function",received:t,path:n})}}),M.prototype.assert(function(t){return!(t.length>this.definition.arguments.length)||t},function(t){return`expecting ${this.definition.arguments.length} arguments for ${p(this)}, got ${t.length}`});const C=["set","delete","clear"];a(S,b,{toString(t){return"Map of "+p(this.definition,t)},_validate(t,n,e,r){if(t instanceof Map)for(let[i,o]of t)h(o,this.definition,`${n||"Map"}[${i}]`,e,r);else e.push({expected:this,received:t,path:n});y(t,this,e)}});const _=["add","delete","clear"];a(E,b,{toString(t){return"Set of "+p(this.definition,t)},_validate(t,n,e,r){if(t instanceof Set)for(let i of t.values())h(i,this.definition,n||"Set",e,r);else e.push({expected:this,received:t,path:n});y(t,this,e)}}),t.Model=b,t.BasicModel=v,t.ObjectModel=O,t.ArrayModel=j,t.FunctionModel=M,t.MapModel=S,t.SetModel=E,Object.defineProperty(t,"__esModule",{value:!0})});
//# sourceMappingURL=object-model.min.js.map
